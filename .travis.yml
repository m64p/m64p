env:
  - CAN_FAIL=true

language: shell
jobs:
  allow_failures: 
    env:
      - CAN_FAIL=true
  include:
  - stage: build-mac
    os:
      - osx
    osx_image: xcode10.2
    compiler:
      - gcc
    before_install:
      - brew update
      - brew upgrade
      - brew install libsamplerate hidapi sdl2_net sdl2 awscli
    script:
      - export qt_version=$(ls /usr/local/Cellar/qt)
      - sudo ln -s /usr/local/Cellar/qt/$qt_version/plugins /usr/local/plugins
      - sudo ln -s /usr/local/Cellar/qt/$qt_version/mkspecs /usr/local/mkspecs
      - sudo ln -s /usr/local/Cellar/qt/$qt_version/bin/qmake /usr/local/bin/qmake
      - export PATH=$PATH:/usr/local/Cellar/qt/$qt_version/bin
      - sudo sh ./build.sh
    after_success:
    - aws s3 cp mupen64plus/m64p-*.dmg s3://m64p/m64p/ --quiet
  - stage: build-linux
    dist: bionic
    before_install:
    - sudo apt-get -qq update
    - sudo apt-get -y dist-upgrade
    - sudo apt-get -y install awscli cmake libhidapi-dev lsb-release wget libminizip-dev libsdl2-dev libfreetype6-dev libgl1-mesa-dev libglu1-mesa-dev pkg-config zlib1g-dev binutils-dev libspeexdsp-dev libsamplerate0-dev qt5-default build-essential nasm git zip libsdl2-net-dev libqt5websockets5-dev
    script:
    - bash ./build.sh
    after_success:
    - aws s3 cp m64p-*.zip s3://m64p/m64p/ --quiet
  - stage: build-windows
    os: windows
    before_install:
    - "[[ ! -f C:/tools/msys64/msys2_shell.cmd ]] && rm -rf C:/tools/msys64"
    - choco uninstall -y mingw
    - choco upgrade --no-progress -y msys2
    - export msys2='cmd //C RefreshEnv.cmd '
    - export msys2+='& set MSYS=winsymlinks:nativestrict '
    - export msys2+='& C:\\tools\\msys64\\msys2_shell.cmd -defterm -no-start'
    - export mingw64="$msys2 -mingw64 -full-path -here -c "\"\$@"\" --"
    - export msys2+=" -msys2 -c "\"\$@"\" --"
    - $msys2 pacman --sync --noconfirm --needed mingw-w64-x86_64-toolchain
    - $msys2 pacman -Syu --noconfirm
    - $msys2 pacman -S --needed --noconfirm make mingw-w64-x86_64-cmake mingw-w64-x86_64-gcc mingw-w64-x86_64-hidapi mingw-w64-x86_64-freetype mingw-w64-x86_64-libpng mingw-w64-x86_64-libsamplerate mingw-w64-x86_64-SDL2 mingw-w64-x86_64-SDL2_net mingw-w64-x86_64-jasper mingw-w64-x86_64-qt5 mingw-w64-x86_64-python3-pip mingw-w64-x86_64-python3-pyopenssl zip
    - export PATH=/C/tools/msys64/mingw64/bin:$PATH
    script:
    - export HOST_CPU=x86_64; $mingw64 ./build.sh
    after_success:
    - $mingw64 python3 -m pip install awscli
    - $mingw64 aws s3 cp m64p-*.zip s3://m64p/m64p/ --quiet
